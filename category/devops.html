<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Kishore's Blog - DevOps</title>
        <link rel="stylesheet" href="https://kishorechandran41.github.io/theme/css/main.css" />
        <link href="https://kishorechandran41.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kishore's Blog Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://kishorechandran41.github.io/">Kishore's Blog</a></h1>
                <nav><ul>
                    <li class="active"><a href="https://kishorechandran41.github.io/category/devops.html">DevOps</a></li>
                    <li><a href="https://kishorechandran41.github.io/category/front-end.html">Front End</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://kishorechandran41.github.io/Elasticsearch-Cluster-on-Google-Kubernetes-Engine.html">Elasticsearch Cluster on Google Kubernetes Engine</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-09-07T17:30:00+05:30">
                Published: Mon 07 September 2020
        </abbr>
		<br />
        <abbr class="modified" title="2020-09-07T17:30:00+05:30">
                Updated: Mon 07 September 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://kishorechandran41.github.io/author/kishore-chandran.html">Kishore Chandran</a>
        </address>
<p>In <a href="https://kishorechandran41.github.io/category/devops.html">DevOps</a>.</p>
<p>tags: <a href="https://kishorechandran41.github.io/tag/elasticsearch.html">Elasticsearch</a> <a href="https://kishorechandran41.github.io/tag/kubernetes.html">Kubernetes</a> </p>
</footer><!-- /.post-info --><p>From being an Java Developer this is the first time I am wetting my hands on Elasticsearch and Kubernetes, 
though I hear a lot about them never really had a chance to work on those. 
Here I share my experience on creating an Elasticsearch Cluster on Google Kubernetes Engine.</p>
<p>These are the following steps involved in the process,</p>
<ol>
<li>Provision the required clusters on <a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine</a>.</li>
<li>Enable Persistent volume using <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">Storage Classes</a>.</li>
<li>Enable Elasticsearch node discovery using <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">Headless Service</a>.</li>
<li>Deploy Elasticsearch Cluster using <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">Stateful Sets</a>.</li>
</ol>
<h2>Provisioning the Cluster</h2>
<p>Let us first provision the clusters in Google Kubernetes Engine for our Elasticsearch. We are going to create 3 node pools as below,</p>
<ol>
<li>master-nodes - 3 nodes with 2vCPU, 8GB Memory and Standard persistent disk of 10GB as default</li>
<li>data-nodes - 5 nodes with 16vCPU, 64GB Memory and Standard persistent disk of 10GB as default</li>
<li>coordinator-only - 5 nodes with 4vCPU, 8GB Memory and Standard persistent disk of 10GB as default</li>
</ol>
<p>You can use the below command to provision.</p>
<div class="highlight"><pre><span></span><code><span class="n">gcloud</span> <span class="n">beta</span> <span class="n">container</span> <span class="o">--</span><span class="n">project</span> <span class="s">&quot;my-project&quot;</span> <span class="n">clusters</span> <span class="n">create</span> <span class="s">&quot;my-cluster&quot;</span> <span class="o">--</span><span class="n">zone</span> <span class="s">&quot;us-central1-c&quot;</span> \
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">basic</span><span class="o">-</span><span class="n">auth</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">version</span> <span class="s">&quot;1.15.12-gke.2&quot;</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;e2-standard-2&quot;</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;COS&quot;</span> \
<span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;pd-standard&quot;</span> <span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="n">size</span> <span class="s">&quot;10&quot;</span> <span class="o">--</span><span class="n">metadata</span> <span class="k">disable</span><span class="o">-</span><span class="n">legacy</span><span class="o">-</span><span class="n">endpoints</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="n">scopes</span> <span class="s">&quot;https://www.googleapis.com/auth/devstorage.read_only&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/logging.write&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/monitoring&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/servicecontrol&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/service.management.readonly&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/trace.append&quot;</span> \
<span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">nodes</span> <span class="s">&quot;3&quot;</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">stackdriver</span><span class="o">-</span><span class="n">kubernetes</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">ip</span><span class="o">-</span><span class="n">alias</span> <span class="o">--</span><span class="n">network</span> <span class="s">&quot;projects/datamastering/global/networks/default&quot;</span> \
<span class="o">--</span><span class="n">subnetwork</span> <span class="s">&quot;projects/datamastering/regions/us-central1/subnetworks/default&quot;</span> <span class="o">--</span><span class="k">default</span><span class="o">-</span><span class="n">max</span><span class="o">-</span><span class="n">pods</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">node</span> <span class="s">&quot;110&quot;</span> \
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">authorized</span><span class="o">-</span><span class="n">networks</span> <span class="o">--</span><span class="n">addons</span> <span class="n">HorizontalPodAutoscaling</span><span class="p">,</span><span class="n">HttpLoadBalancing</span><span class="p">,</span><span class="n">GcePersistentDiskCsiDriver</span> \
<span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autoupgrade</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autorepair</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">surge</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">1</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">unavailable</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">0</span> <span class="o">&amp;&amp;</span> <span class="n">gcloud</span> <span class="n">beta</span> <span class="n">container</span> \
<span class="o">--</span><span class="n">project</span> <span class="s">&quot;datamastering&quot;</span> <span class="n">node</span><span class="o">-</span><span class="n">pools</span> <span class="n">create</span> <span class="s">&quot;data-nodes&quot;</span> \
<span class="o">--</span><span class="n">cluster</span> <span class="s">&quot;my-cluster&quot;</span> <span class="o">--</span><span class="n">zone</span> <span class="s">&quot;us-central1-c&quot;</span> <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">version</span> <span class="s">&quot;1.15.12-gke.2&quot;</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;e2-standard-16&quot;</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;COS&quot;</span> \
<span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;pd-standard&quot;</span> <span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="n">size</span> <span class="s">&quot;10&quot;</span> <span class="o">--</span><span class="n">metadata</span> <span class="k">disable</span><span class="o">-</span><span class="n">legacy</span><span class="o">-</span><span class="n">endpoints</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="n">scopes</span> <span class="s">&quot;https://www.googleapis.com/auth/devstorage.read_only&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/logging.write&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/monitoring&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/servicecontrol&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/service.management.readonly&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/trace.append&quot;</span> \
<span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">nodes</span> <span class="s">&quot;5&quot;</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autoupgrade</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autorepair</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">surge</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">1</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">unavailable</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">0</span> <span class="o">&amp;&amp;</span> <span class="n">gcloud</span> <span class="n">beta</span> <span class="n">container</span> \
<span class="o">--</span><span class="n">project</span> <span class="s">&quot;datamastering&quot;</span> <span class="n">node</span><span class="o">-</span><span class="n">pools</span> <span class="n">create</span> <span class="s">&quot;coordinator-only&quot;</span> <span class="o">--</span><span class="n">cluster</span> <span class="s">&quot;my-cluster&quot;</span> <span class="o">--</span><span class="n">zone</span> <span class="s">&quot;us-central1-c&quot;</span> \
<span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">version</span> <span class="s">&quot;1.15.12-gke.2&quot;</span> <span class="o">--</span><span class="n">machine</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;e2-custom-4-8192&quot;</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;COS&quot;</span> <span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="k">type</span> <span class="s">&quot;pd-standard&quot;</span> \
<span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="n">size</span> <span class="s">&quot;10&quot;</span> <span class="o">--</span><span class="n">metadata</span> <span class="k">disable</span><span class="o">-</span><span class="n">legacy</span><span class="o">-</span><span class="n">endpoints</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="n">scopes</span> <span class="s">&quot;https://www.googleapis.com/auth/devstorage.read_only&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/logging.write&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/monitoring&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/servicecontrol&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/service.management.readonly&quot;</span><span class="p">,</span><span class="s">&quot;https://www.googleapis.com/auth/trace.append&quot;</span> \
<span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">nodes</span> <span class="s">&quot;2&quot;</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autoupgrade</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">autorepair</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">surge</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">1</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">unavailable</span><span class="o">-</span><span class="n">upgrade</span> <span class="mh">0</span>
</code></pre></div>

<blockquote>
<p><strong><em>NOTE:</em></strong>  In case you are provisioning the cluster in console make sure to enable <code>Enable Computer Engine Persistent Disk CSI Driver</code> 
under Features.</p>
</blockquote>
<h2>Enable Persistent Volume</h2>
<p>Next we create the storage classes for our Elasticsearch cluster, Create new file called <code>storage.yaml</code> with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="n">allowVolumeExpansion</span><span class="o">:</span> <span class="kc">true</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">storage</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StorageClass</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
<span class="n">parameters</span><span class="o">:</span>
  <span class="n">type</span><span class="o">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
<span class="n">provisioner</span><span class="o">:</span> <span class="n">pd</span><span class="o">.</span><span class="na">csi</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">gke</span><span class="o">.</span><span class="na">io</span>
<span class="n">reclaimPolicy</span><span class="o">:</span> <span class="n">Delete</span>
<span class="n">volumeBindingMode</span><span class="o">:</span> <span class="n">Immediate</span>
</code></pre></div>

<p>Here we use <code>pd.csi.storage.gke.io</code> as our provisioner, this is the reason we enabled 
<code>Enable Computer Engine Persistent Disk CSI Driver</code> under Features of cluster creation.</p>
<p>In case you dont want to use the above provisioner you can also use the <code>kubernetes.io/gce-pd</code> as bellow.</p>
<div class="highlight"><pre><span></span><code><span class="n">kind</span><span class="o">:</span> <span class="n">StorageClass</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">storage</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
<span class="n">provisioner</span><span class="o">:</span> <span class="n">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">gce</span><span class="o">-</span><span class="n">pd</span>
<span class="n">parameters</span><span class="o">:</span>
  <span class="n">type</span><span class="o">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
  <span class="n">zone</span><span class="o">:</span> <span class="n">us</span><span class="o">-</span><span class="n">central1</span><span class="o">-</span><span class="n">c</span>
</code></pre></div>

<blockquote>
<p><strong><em>NOTE:</em></strong>  Use only one of the above since we have used the same name for both, in case you want to use both the 
configurations use different names for <code>pd-ssd</code>.</p>
</blockquote>
<p>Now to apply the changes to our cluster first get credentials of our cluster using the bellow command.</p>
<p><code>gcloud container clusters get-credentials my-cluster --zone us-central1-c --project my-project</code></p>
<p>To apply our changes use the below command.</p>
<p><code>kubectl apply -f storage.yaml</code></p>
<h2>Elasticsearch Node Discovery</h2>
<p>Create new file called <code>service.yaml</code> with the following content.</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">es</span><span class="o">-</span><span class="n">lb</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">default</span>
  <span class="n">annotations</span><span class="p">:</span>
    <span class="c1"># NOTE: We recommend only exposing ES on your internal network</span>
    <span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="nb">load</span><span class="o">-</span><span class="n">balancer</span><span class="o">-</span><span class="n">type</span><span class="p">:</span> <span class="s2">&quot;Internal&quot;</span>
    <span class="c1"># If you are using external DNS you can have it publish the dns records</span>
    <span class="c1"># for this service for you</span>
    <span class="n">external</span><span class="o">-</span><span class="n">dns</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">hostname</span><span class="p">:</span> <span class="s2">&quot;es-lb.example.com.&quot;</span>
    <span class="n">external</span><span class="o">-</span><span class="n">dns</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ttl</span><span class="p">:</span> <span class="s2">&quot;30&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">LoadBalancer</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">https</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">9200</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">9200</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">common</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">type</span><span class="p">:</span> <span class="n">elasticsearch</span>
    <span class="n">elasticsearch</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span><span class="p">:</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span>
  <span class="n">sessionAffinity</span><span class="p">:</span> <span class="n">None</span>
</code></pre></div>

<p>Then enable the headless service using the following command</p>
<p><code>kubectl apply -f service.yaml</code></p>
<h2>Deploy Elasticsearch Cluster</h2>
<p>The last step is to deploy the elasticsearch cluster, to deploy the ECK operator run,</p>
<p><code>kubectl apply -f https://download.elastic.co/downloads/eck/1.2.0/all-in-one.yaml</code>
This will deploy it into the elastic-system namespace. For latest version of the operator you find install instructions 
<a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html">here</a>.</p>
<p>To deploy to our cluster create <code>elasticsearch.yaml</code> with the below content.</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span> <span class="n">elasticsearch</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Elasticsearch</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">6.8</span><span class="o">.</span><span class="mi">3</span>
  <span class="n">nodeSets</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">masters</span>
    <span class="n">count</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">podTemplate</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">master</span><span class="o">-</span><span class="n">nodes</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">6.8</span><span class="o">.</span><span class="mi">3</span>
          <span class="n">env</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ES_JAVA_OPTS</span>
            <span class="n">value</span><span class="p">:</span> <span class="o">-</span><span class="n">Xms6g</span> <span class="o">-</span><span class="n">Xmx6g</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="k">master</span><span class="o">-</span><span class="n">nodes</span>
          <span class="n">resources</span><span class="p">:</span>
            <span class="n">requests</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">8</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">limits</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">8</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">initContainers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">sysctl</span>
          <span class="n">securityContext</span><span class="p">:</span>
            <span class="n">privileged</span><span class="p">:</span> <span class="bp">true</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;sysctl -w vm.max_map_count=262144&#39;</span><span class="p">]</span>
        <span class="c1"># see https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-init-containers-plugin-downloads.html</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span><span class="o">-</span><span class="n">plugins</span>
          <span class="n">command</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">sh</span>
          <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
          <span class="o">-</span> <span class="o">|</span>
            <span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">plugin</span> <span class="n">install</span> <span class="o">--</span><span class="n">batch</span> <span class="n">repository</span><span class="o">-</span><span class="n">gcs</span>
    <span class="n">config</span><span class="p">:</span>
      <span class="n">node</span><span class="o">.</span><span class="k">master</span><span class="p">:</span> <span class="bp">true</span>
      <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="bp">false</span>
      <span class="n">node</span><span class="o">.</span><span class="n">ingest</span><span class="p">:</span> <span class="bp">false</span>
      <span class="n">script</span><span class="o">.</span><span class="n">allowed_types</span><span class="p">:</span> <span class="n">inline</span>
      <span class="n">path</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span> <span class="o">/</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">fielddata</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="o">%</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">bool</span><span class="o">.</span><span class="n">max_clause_count</span><span class="p">:</span> <span class="mi">4096</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">index_buffer_size</span><span class="p">:</span> <span class="s2">&quot;25%&quot;</span>
    <span class="n">volumeClaimTemplates</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">masters</span><span class="o">-</span><span class="n">data</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">accessModes</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">ReadWriteOnce</span>
        <span class="n">resources</span><span class="p">:</span>
          <span class="n">requests</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">:</span> <span class="mi">500</span><span class="n">Gi</span>
        <span class="n">storageClassName</span><span class="p">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">data</span><span class="o">-</span><span class="n">nodes</span>
    <span class="n">count</span><span class="p">:</span> <span class="mi">5</span>
    <span class="n">podTemplate</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">data</span><span class="o">-</span><span class="n">nodes</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">6.8</span><span class="o">.</span><span class="mi">3</span>
          <span class="n">env</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ES_JAVA_OPTS</span>
            <span class="n">value</span><span class="p">:</span> <span class="o">-</span><span class="n">Xms28g</span> <span class="o">-</span><span class="n">Xmx28g</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">data</span><span class="o">-</span><span class="n">nodes</span>
          <span class="n">resources</span><span class="p">:</span>
            <span class="n">requests</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">36</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">4</span>
            <span class="n">limits</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">36</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">4</span>
        <span class="n">initContainers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">sysctl</span>
          <span class="n">securityContext</span><span class="p">:</span>
            <span class="n">privileged</span><span class="p">:</span> <span class="bp">true</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;sysctl -w vm.max_map_count=262144&#39;</span><span class="p">]</span>
        <span class="c1"># see https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-init-containers-plugin-downloads.html</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span><span class="o">-</span><span class="n">plugins</span>
          <span class="n">command</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">sh</span>
          <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
          <span class="o">-</span> <span class="o">|</span>
            <span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">plugin</span> <span class="n">install</span> <span class="o">--</span><span class="n">batch</span> <span class="n">repository</span><span class="o">-</span><span class="n">gcs</span>
    <span class="n">config</span><span class="p">:</span>
      <span class="n">node</span><span class="o">.</span><span class="k">master</span><span class="p">:</span> <span class="bp">false</span>
      <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="bp">true</span>
      <span class="n">script</span><span class="o">.</span><span class="n">allowed_types</span><span class="p">:</span> <span class="n">inline</span>
      <span class="n">path</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span> <span class="o">/</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">fielddata</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="o">%</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">bool</span><span class="o">.</span><span class="n">max_clause_count</span><span class="p">:</span> <span class="mi">4096</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">index_buffer_size</span><span class="p">:</span> <span class="s2">&quot;25%&quot;</span>
    <span class="n">volumeClaimTemplates</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">data</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">accessModes</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">ReadWriteOnce</span>
        <span class="n">resources</span><span class="p">:</span>
          <span class="n">requests</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">:</span> <span class="mi">500</span><span class="n">Gi</span>
        <span class="n">storageClassName</span><span class="p">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">coordinator</span><span class="o">-</span><span class="n">only</span>
    <span class="n">count</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">podTemplate</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">coordinator</span><span class="o">-</span><span class="n">only</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">6.8</span><span class="o">.</span><span class="mi">3</span>
          <span class="n">env</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ES_JAVA_OPTS</span>
            <span class="n">value</span><span class="p">:</span> <span class="o">-</span><span class="n">Xms4g</span> <span class="o">-</span><span class="n">Xmx4g</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">coordinator</span><span class="o">-</span><span class="n">only</span>
          <span class="n">resources</span><span class="p">:</span>
            <span class="n">requests</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">6</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">limits</span><span class="p">:</span>
              <span class="n">memory</span><span class="p">:</span> <span class="mi">6</span><span class="n">Gi</span>
              <span class="n">cpu</span><span class="p">:</span> <span class="mi">3</span>
        <span class="n">initContainers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">sysctl</span>
          <span class="n">securityContext</span><span class="p">:</span>
            <span class="n">privileged</span><span class="p">:</span> <span class="bp">true</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;sysctl -w vm.max_map_count=262144&#39;</span><span class="p">]</span>
        <span class="c1"># see https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-init-containers-plugin-downloads.html</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span><span class="o">-</span><span class="n">plugins</span>
          <span class="n">command</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">sh</span>
          <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
          <span class="o">-</span> <span class="o">|</span>
            <span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">plugin</span> <span class="n">install</span> <span class="o">--</span><span class="n">batch</span> <span class="n">repository</span><span class="o">-</span><span class="n">gcs</span>
    <span class="n">config</span><span class="p">:</span>
      <span class="n">node</span><span class="o">.</span><span class="k">master</span><span class="p">:</span> <span class="bp">false</span>
      <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="bp">false</span>
      <span class="n">node</span><span class="o">.</span><span class="n">ingest</span><span class="p">:</span> <span class="bp">true</span>
      <span class="n">script</span><span class="o">.</span><span class="n">allowed_types</span><span class="p">:</span> <span class="n">inline</span>
      <span class="n">path</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span> <span class="o">/</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">fielddata</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="o">%</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">bool</span><span class="o">.</span><span class="n">max_clause_count</span><span class="p">:</span> <span class="mi">4096</span>
      <span class="n">indices</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">index_buffer_size</span><span class="p">:</span> <span class="s2">&quot;25%&quot;</span>
    <span class="n">volumeClaimTemplates</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">coordinator</span><span class="o">-</span><span class="n">data</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">accessModes</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">ReadWriteOnce</span>
        <span class="n">resources</span><span class="p">:</span>
          <span class="n">requests</span><span class="p">:</span>
            <span class="n">storage</span><span class="p">:</span> <span class="mi">500</span><span class="n">Gi</span>
        <span class="n">storageClassName</span><span class="p">:</span> <span class="n">pd</span><span class="o">-</span><span class="n">ssd</span>
  <span class="n">http</span><span class="p">:</span>
    <span class="n">service</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">:</span>
        <span class="n">type</span><span class="p">:</span> <span class="n">ClusterIP</span>
    <span class="c1"># see https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-custom-http-certificate.html</span>
    <span class="c1"># tls:</span>
    <span class="c1">#   certificate:</span>
    <span class="c1">#     secretName: &quot;example.com&quot;</span>
</code></pre></div>

<p>To apply the yaml use the bellow command
<code>kubectl apply -f elasticsearch.yaml</code></p>
<p>Now your cluster must be up, confirm the same in Workloads section in the console or you can use the bellow command and see
if all the pods are in running state.
<code>kubectl get pods</code></p>
<h2>Test Your Cluster</h2>
<p>To verify that your cluster is working fine use the below commands to access the content of the cluster</p>
<div class="highlight"><pre><span></span><code><span class="c1"># get the generated password</span>
<span class="n">PASSWORD</span><span class="o">=$</span><span class="p">(</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">secret</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">es</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">user</span> <span class="o">-</span><span class="n">o</span> <span class="n">go</span><span class="o">-</span><span class="n">template</span><span class="o">=</span><span class="s1">&#39;{{.data.elastic | base64decode}}&#39;</span><span class="p">)</span>

<span class="c1"># using the load balancer we created</span>
<span class="n">ENDPOINT</span><span class="o">=$</span><span class="p">(</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">svc</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">es</span><span class="o">-</span><span class="n">lb</span> <span class="o">-</span><span class="n">o</span> <span class="n">go</span><span class="o">-</span><span class="n">template</span><span class="o">=</span><span class="s1">&#39;{{ (index .status.loadBalancer.ingress 0).ip }}&#39;</span><span class="p">)</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="s2">&quot;elastic:$PASSWORD&quot;</span> <span class="o">-</span><span class="n">k</span> <span class="n">https</span><span class="p">:</span><span class="o">//$</span><span class="n">ENDPOINT</span><span class="p">:</span><span class="mi">9200</span>

<span class="c1"># To test locally can set up proxy</span>
<span class="n">kubectl</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">service</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">es</span><span class="o">-</span><span class="n">http</span> <span class="mi">9200</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">u</span> <span class="s2">&quot;elastic:$PASSWORD&quot;</span> <span class="o">-</span><span class="n">k</span> <span class="s2">&quot;https://localhost:9200&quot;</span>
</code></pre></div>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://kishorechandran41.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/kishore-chandran-90456776/">Linkedin</a></li>
                            <li><a href="https://twitter.com/kishorec41">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>